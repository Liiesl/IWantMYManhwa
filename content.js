"use strict";console.log("IWantMYManhwa: Content script loaded on",window.location.href);class SiteAdapter{constructor(t={}){this.config=t,this.name=t.name||"Unknown Site",this.domains=t.domains||[]}matchesUrl(t){return!!t&&this.domains.some(e=>new RegExp(`https?://[^/]*${e.replace(/\./g,"\\.")}`,"i").test(t))}getTitle(){const t=this.getTitleSelectors();for(const e of t){const t=document.querySelector(e);if(t&&t.textContent?.trim())return t.textContent.trim()}const e=document.title;return e?e.split(/[-–—\|]/)[0].trim():"Unknown Title"}extractChapterNumber(t,e=""){if(!t)return null;try{const e=new URL(t).pathname.split("/").filter(t=>t.length>0).pop();if(e){const t=e.match(/^chapter-([\d\.]+)/i);if(t)return parseFloat(t[1]);if(/^[\d\.]+$/.test(e))return parseFloat(e)}}catch(t){}if(e){const t=e.match(/^[\d\.]+/);if(t)return parseFloat(t[0])}return null}getChapterListSelectors(){throw new Error("getChapterListSelectors() must be implemented by subclass")}getTitleSelectors(){throw new Error("getTitleSelectors() must be implemented by subclass")}getImageSelectors(){throw new Error("getImageSelectors() must be implemented by subclass")}isChapterUrl(t){throw new Error("isChapterUrl() must be implemented by subclass")}cleanChapterName(t){return t?t.replace(/^chapter\s+/i,"").replace(/^ch\.\s*/i,"").trim():"Unknown Chapter"}getDownloadConfig(){return{maxConcurrentTabs:3,tabLoadTimeoutMs:6e4,scriptResponseTimeoutMs:3e4,imageFetchTimeoutMs:45e3,imageFetchRetries:3,imageRetryDelayMs:1e3,delayBetweenTaskStartMs:200,delayAfterTaskFinishMs:500,zipCompressionLevel:6,...this.config.download||{}}}getNamingPattern(){return{chapterFolder:"Chapter_{number}",imageFile:"{number}.{extension}",zipFile:"{title}_Chapter_{number}.zip",...this.config.naming||{}}}getImageUrl(t){if(!t)return null;const e=t.dataset?.src||t.dataset?.lazySrc||t.getAttribute("data-src")||t.getAttribute("data-lazy-src")||t.src;return e&&"string"==typeof e&&e.startsWith("http")?e.trim():null}isValidChapterLink(t,e){return!!t.closest("li")}sortChapters(t){return t.sort((t,e)=>{const r=this.extractChapterNumber(t.url,t.name),n=this.extractChapterNumber(e.url,e.name);return null!==r&&null!==n?r-n:t.name.localeCompare(e.name)})}async downloadChapter(t,e,r,n={}){throw new Error("downloadChapter() must be implemented by subclass")}}try{"undefined"!=typeof window&&(window.SiteAdapter=SiteAdapter),"undefined"!=typeof globalThis&&(globalThis.SiteAdapter=SiteAdapter),"undefined"!=typeof self&&(self.SiteAdapter=SiteAdapter)}catch(t){console.error("[SiteAdapter] Failed to set global:",t)}"undefined"!=typeof module&&module.exports&&(module.exports=SiteAdapter);class WebtoonscanContentAdapter extends SiteAdapter{constructor(t={}){super({name:"Webtoonscan",domains:["webtoonscan.com","cdn4.webtoonscan.com"],...t})}isChapterListingPage(t){return!!t&&t.includes("webtoonscan.com/manhwa/")&&!this.isChapterUrl(t)}getChapterListSelectors(){return["div.page-content-listing.single-page ul.main.version-chap li.wp-manga-chapter a","div.listing-chapters_wrap ul li a","div.version-chap ul li a","ul.version-chap li a"]}getTitleSelectors(){return["h1.post-title",".post-title h1",".post-title h3",".entry-title",".main-info .container h1"]}getImageSelectors(){return["div.reading-content div.page-break img.wp-manga-chapter-img","div.read-container img.viewer-image"]}isChapterUrl(t){if(!t)return!1;try{const e=new URL(t).pathname.split("/").filter(t=>t.length>0).pop();if(e)return(/^chapter-[\d\.]+$/i.test(e)||/^[\d\.]+$/.test(e))&&t.includes("webtoonscan.com")}catch(t){return!1}return!1}isValidChapterLink(t,e){if(!t.closest("li.wp-manga-chapter, li"))return!1;const r=t.textContent?.trim();return!(!r||0===r.length)}extractChapterNumberFromUrl(t){if(!t)return null;try{const e=new URL(t).pathname.split("/").filter(t=>t.length>0).pop();if(e){const t=e.match(/^chapter-([\d\.]+)/i);if(t)return parseFloat(t[1]);if(/^[\d\.]+$/.test(e))return parseFloat(e)}}catch(t){return null}return null}getChapters(){const t=[],e=this.getChapterListSelectors(),r=new Set;for(const n of e){const e=document.querySelectorAll(n);for(const n of e){const e=n.href?.trim();if(!e)continue;if(!this.isChapterUrl(e))continue;if(!this.isValidChapterLink(n,e))continue;if(r.has(e))continue;const a=this.cleanChapterName(n.textContent);t.push({name:a,url:e}),r.add(e)}}return this.sortChapters(t)}getChapterImages(){const t=[],e=this.getImageSelectors();for(const r of e){const e=document.querySelectorAll(r);for(const r of e){const e=this.getImageUrl(r);e&&t.push(e)}if(t.length>0)break}return t}sortChapters(t){return t.sort((t,e)=>{const r=this.extractChapterNumberFromUrl(t.url),n=this.extractChapterNumberFromUrl(e.url);if(null!==r&&null!==n)return r-n;const a=parseFloat(t.name.match(/^[\d\.]+/)?.[0]),s=parseFloat(e.name.match(/^[\d\.]+/)?.[0]);return isNaN(a)||isNaN(s)?t.name.localeCompare(e.name):a-s})}}class AsuraScansContentAdapter extends SiteAdapter{constructor(t={}){super({name:"AsuraScans",domains:["asuracomic.net","beta.asuracomic.net"],...t})}isChapterListingPage(t){return!!t&&t.includes("/series/")&&!this.isChapterUrl(t)}getChapterListSelectors(){return['div[class*="space-y-"] a[href*="/chapter/"]','div.max-h-\\[20rem\\] a[href*="/chapter/"]']}getTitleSelectors(){return["span.text-xl.font-bold","h1.text-xl.font-bold"]}getImageSelectors(){return["div.py-8 img.object-cover","div.py-8 img"]}isChapterUrl(t){if(!t)return!1;try{const e=new URL(t).pathname.split("/").filter(t=>t.length>0),r=e.indexOf("chapter");if(-1!==r&&r+1<e.length){const n=e[r+1];return/^\d+$/.test(n)&&t.includes("asuracomic.net")}}catch(t){return!1}return!1}isValidChapterLink(t,e){if(!e||!e.includes("/chapter/"))return!1;const r=t.textContent?.trim();return r&&r.length>0}extractChapterNumberFromUrl(t){if(!t)return null;try{const e=new URL(t).pathname.split("/").filter(t=>t.length>0),r=e.indexOf("chapter");if(-1!==r&&r+1<e.length)return parseFloat(e[r+1])}catch(t){return null}return null}getChapters(){const t=[],e=this.getChapterListSelectors(),r=new Set;for(const n of e){const e=document.querySelectorAll(n);for(const n of e){const e=n.href?.trim();if(!e)continue;if(!this.isChapterUrl(e))continue;if(!this.isValidChapterLink(n,e))continue;if(r.has(e))continue;const a=this.cleanChapterName(n.textContent);t.push({name:a,url:e}),r.add(e)}}return this.sortChapters(t)}getChapterImages(){const t=[],e=this.getImageSelectors();for(const r of e){const e=document.querySelectorAll(r);for(const r of e){const e=this.getImageUrl(r);e&&(e.includes("EndDesign")||t.push(e))}if(t.length>0)break}return t}sortChapters(t){return t.sort((t,e)=>{const r=this.extractChapterNumberFromUrl(t.url),n=this.extractChapterNumberFromUrl(e.url);if(null!==r&&null!==n)return n-r;const a=parseFloat(t.name.match(/^[\d\.]+/)?.[0]),s=parseFloat(e.name.match(/^[\d\.]+/)?.[0]);return isNaN(a)||isNaN(s)?t.name.localeCompare(e.name):s-a})}}"undefined"!=typeof window&&(window.AsuraScansContentAdapter=AsuraScansContentAdapter),"undefined"!=typeof globalThis&&(globalThis.AsuraScansContentAdapter=AsuraScansContentAdapter),"undefined"!=typeof self&&(self.AsuraScansContentAdapter=AsuraScansContentAdapter);class SiteRegistry{constructor(){this.adapters=new Map,this.defaultAdapter=null}register(t,e,r=!1){if(!t||!e)throw new Error("SiteRegistry: name and adapter are required");this.adapters.set(t,e),!r&&this.defaultAdapter||(this.defaultAdapter=e),console.log(`[SiteRegistry] Registered adapter: ${t}`)}get(t){return this.adapters.get(t)||null}findAdapterForUrl(t){if(!t)return null;for(const[e,r]of this.adapters)if(r.matchesUrl(t))return r;return null}isSupported(t){return null!==this.findAdapterForUrl(t)}getRegisteredSites(){return Array.from(this.adapters.keys())}}const siteRegistry=new SiteRegistry;siteRegistry.initialize=function(){this.adapters.clear(),void 0!==WebtoonscanContentAdapter&&this.register("webtoonscan",new WebtoonscanContentAdapter,!0),void 0!==AsuraScansContentAdapter&&this.register("asurascans",new AsuraScansContentAdapter,!0)},siteRegistry.initialize(),chrome.runtime.onMessage.addListener((t,e,r)=>{if("getChapters"===t.action){console.log("[Content Script] Received request: getChapters");try{const t=window.location.href,e=siteRegistry.findAdapterForUrl(t);if(!e)return console.error("[Content Script] No adapter found for URL:",t),r({action:"error",error:`No adapter found for this site: ${t}`,title:"Unknown",chapters:[]}),!0;console.log(`[Content Script] Using adapter: ${e.name}`);const n=e.getChapters();console.log(`[Content Script] Found ${n.length} chapters.`),r({action:"chaptersFound",title:e.getTitle(),chapters:n,siteName:e.name})}catch(t){console.error("[Content Script] Error:",t),r({action:"error",error:t.message,title:"Unknown",chapters:[]})}return!0}return!1}),chrome.runtime.sendMessage({action:"contentScriptReady",url:window.location.href}),console.log("[Content Script] Ready");